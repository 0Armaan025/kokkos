#!/bin/bash -e

CXX_COMPILER="@CMAKE_CXX_COMPILER@"

if [ -z "${1}" ]; then exit 0; fi

# find the nvcc_wrapper from the same build/install
LOCAL_NVCC_WRAPPER="@Kokkos_NVCC_WRAPPER@"

# find the nvcc_wrapper in the path
: ${BIN_NVCC_WRAPPER:-"$(which nvcc_wrapper)"}

# the nvcc_wrapper to be used if not specified in env
: ${NVCC_WRAPPER:=${BIN_NVCC_WRAPPER:-"${LOCAL_NVCC_WRAPPER}"}}

if [ -z "${NVCC_WRAPPER}" ]; then
    echo "Error: nvcc_wrapper not found. Please specify NVCC_WRAPPER or add it to PATH"
    exit 1
fi

# set default nvcc wrapper compiler if not specified
: ${NVCC_WRAPPER_DEFAULT_COMPILER:=${1}}
export NVCC_WRAPPER_DEFAULT_COMPILER

if [ "$(basename ${1})" != "$(basename @CMAKE_CXX_COMPILER@)" ]; then
    eval $@
else
    # do not pass the compiler command
    shift

    # execute nvcc_wrapper
    # set -x
    ${NVCC_WRAPPER} $@
fi
